<!DOCTYPE html>
<html>
  <head>
    <title>RestoTracker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/gmaps-sidebar.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script src="https://use.fontawesome.com/dfec85f8f4.js"></script>
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        p {
          margin: 15px 0;
        }

        .hide {
          display: none !important;
        }

        .mdl-list__item--three-line {
          height: auto;
        }

        .mdl-list__item-primary-content h5 {
          display: inline;
        }

        .mdl-list__item-primary-content h5 .mdl-list__item-secondary-action {
          display: inline-block;
          vertical-align: middle;
        }

        .mdl-list__item--three-line .mdl-list__item-text-body {
          height: auto;
        }

        .review-counter {
          border-radius: 100%;
          background-color: rgb(255,64,129);
          text-align: center;
          width: 24px;
          height: 24px;
          display: inline-block;
          vertical-align: middle;
          font-size: 14px;
          color: #fff;
          line-height: 24px;
          font-weight: 500;
          margin-left: 5px;
        }

        .mdl-list__item--three-line .mdl-list__item-primary-content {
          height: auto;
          line-height: auto;
        }

        .mdl-list__item-primary-content img {
          width: 60px;
          height: 60px;
        }

        .marker-counter {
          background-color: rgba(0,0,0,0.7);
          color: #fff;
          position: absolute;
          border-radius: 2px;
          left: 75px;
          bottom: 5px;
          font-size: 10px;
          padding: 5px 10px;
          text-transform: uppercase;
          font-family: Arial, sans-serif;
        }
    </style>
    <script>
      // TODO
      // 1. Add new custom type
      // 2. Set center on drag
      var types = [
        'pizza',
        'burger',
        'pasta',
        'chicken',
        'barbecue',
        'seafood',
        'soup',
        'noodles',
        'lechon',
        'salad'
      ];
      var map;
      var infowindow;
      var service;
      var directionsDisplay;
      var directionsService;
      var markers = [];
      var count = [];
      var circle;
      var cebu = {lat: 10.31672, lng: 123.89071};
      var loc = cebu;
      var population = 922611; //922,611
      var radius = Math.sqrt(population) * 100;
      var marker_counter = 0;

      function initMap() {
        directionsDisplay = new google.maps.DirectionsRenderer();
        directionsService = new google.maps.DirectionsService();

        map = new google.maps.Map(document.getElementById('map'), {
          center: cebu,
          zoom: 9
        });
        directionsDisplay.setMap(map);

        infowindow = new google.maps.InfoWindow();
        service = new google.maps.places.PlacesService(map);

        google.maps.event.addListener(map, 'click', function() {
          infowindow.close();
        });

        scanRestaurants(service, cebu, radius);

        circle = new google.maps.Circle({
          strokeColor: '#0000FF',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#0000FF',
          fillOpacity: 0.3,
          map: map,
          center: cebu,
          radius: radius
        });

        google.maps.event.addListener(circle, 'radius_changed', function() {
          var location = {
            lat: circle.getCenter().lat(),
            lng: circle.getCenter().lng()
          };

          radius = circle.getRadius();
          setTimeout(function() {
            deleteMarkers();
            scanRestaurants(service, location, radius);
          }, 1500);

          console.log('Radius has been changed to: ' + circle.getRadius());
        });

        google.maps.event.addListener(circle, 'center_changed', function() {
          var location = {
            lat: circle.getCenter().lat(),
            lng: circle.getCenter().lng()
          };

          loc = location;
          setTimeout(function() {
            deleteMarkers();
            scanRestaurants(service, location, circle.getRadius());
          }, 1500);

          console.log('Center has been changed to: ', location);
        });
      }

      function listFormat(review) {
        return '<li class="mdl-list__item mdl-list__item--three-line"> \
          <span class="mdl-list__item-primary-content"> \
            <img src="' + review.profile_photo_url + '" alt="' + review.author_name + '" /> \
            <h5>' + review.author_name + ' \
              <a class="mdl-list__item-secondary-action" href="#" title="' + review.rating.toFixed(1) + '"><i class="material-icons">star</i></a> \
            </h5> \
            <p class="mdl-list__item-text-body" title="' + review.relative_time_description + '"> \
              ' + review.text + ' \
            </span> \
          </span> \
        </li>';
      }

      function addMarker(place) {
        var marker = new google.maps.Marker({
          position: place.geometry.location,
          map: map
        });

        marker.visit_count = 0;

        google.maps.event.addListener(marker, 'click', function() {
          marker.visit_count++;
          service.getDetails({
            placeId: place.place_id
          }, function(pl, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
              $(() => {
                $('[href="#reviews"]').click();
                $('[href="#reviews"]').parent().removeClass('hide');

                var $list = $('#reviews').find('.mdl-list');
                $('#reviews').find('.review-counter').text(pl.reviews.length);
                $list.empty();

                for (let i = 0 ; i < pl.reviews.length ; i++) {
                  $list.append(listFormat(pl.reviews[i]));
                }
              });

            }
          });

          infowindow.setContent('<div> \
            <strong>' + place.name + '</strong><br> \
            ' + place.formatted_address + '<br> \
            <strong>Rating: </strong>' + parseFloat(place.rating).toFixed(1) + '<br> \
            Visited: ' + marker.visit_count + ' times<br> \
          </div');
          infowindow.open(map, this);

          // Directions
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var request = {
                origin: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                destination: new google.maps.LatLng(place.geometry.location.lat(), place.geometry.location.lng()),
                travelMode: 'DRIVING'
              };
              directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                  directionsDisplay.setDirections(result);
                }
              });
            }, function() {
              handleLocationError(true, infoWindow, map.getCenter());
            });
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
          }
        });

        markers.push(marker);
        marker_counter++;
        $('.marker-counter').find('span').text(marker_counter);
      }

      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      function clearMarkers() {
        setMapOnAll(null);
      }

      function deleteMarkers() {
        clearMarkers();
        markers = [];
        marker_counter = 0;
      }

      function showMarkers() {
        setMapOnAll(map);
      }

      function filterMarkers() {
        types = [];
        types = $('input[name="type[]"]').map(function() {
          if ($(this).is(':checked')) {
            return $(this).val();
          }
        }).get();

        deleteMarkers();
        scanRestaurants(service, loc, radius);
      }

      function scanRestaurants(service, location, radius) {
        for (let i = 0 ; i < types.length ; i++) {
          var request = {
            location: location,
            radius: radius,
            query: types[i],
            type: ['restaurant']
          };
          service.textSearch(request, callback);
        }
      }

      function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (let i = 0 ; i < results.length ; i++) {
            addMarker(results[i]);
          }
        }
      }
    </script>
  </head>
  <body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="https://github.com/ravenda900/ravenda900.github.io" role="tab" target="_blank"><i class="fa fa-github"></i></a></li>
                <li class="hide" title="Click a marker to view user reviews"><a href="#reviews" role="tab" target="_blank"><i class="fa fa-user"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    RestoTracker
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <h5>Categories</h5>
                <p id="form-filter"></p>
            </div>

            <div class="sidebar-pane" id="settings">
              <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
              <h5>Circle</h5>
              <p>
                <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-1">
                  <input type="checkbox" id="switch-1" class="mdl-switch__input">
                  <span class="mdl-switch__label">Editable?</span>
                </label>
                <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-2">
                  <input type="checkbox" id="switch-2" class="mdl-switch__input">
                  <span class="mdl-switch__label">Draggable?</span>
                </label>
              </p>
            </div>

            <div class="sidebar-pane" id="reviews">
                <h1 class="sidebar-header">
                    User reviews
                    <span class="review-counter"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <ul class="mdl-list"></ul>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>
    <div class="marker-counter">No of traced restaurants: <span></span></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxlCY3Fma4zvmfVJq0uH2vhAGe1EhMgnk&libraries=places&callback=initMap" async defer></script>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBb4WL2GfoHsP_73RhsDOhJHVSYv14y678&libraries=places&callback=initMap" async defer></script> -->
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIkkdbUqYyfWnsoi5CjV-lzUt__xXWi8Y&libraries=places&callback=initMap" async defer></script> -->
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="js/jquery-sidebar.js"></script>
    <script>
      $(() => {
        var sidebar = $('#sidebar').sidebar();

        $.each(types, (key, value) => {
          let $label = $('<label/>');
          let $input = $('<input/>');
          let $span = $('<span/>');

          $label.attr({
            for: value
          }).addClass('mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect');

          $input.attr({
            type: 'checkbox',
            id: value,
            value: value,
            name: 'type[]'
          }).addClass('mdl-checkbox__input').prop('checked', true);

          $span.addClass('mdl-checkbox__label').text(() => {
            return value.replace(/\w\S*/g, (txt) => {return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
          });

          $('#form-filter').append($label.append($input).append($span));
        });

        $('input[name="type[]"]').on('change', (e) => {
          filterMarkers();
        });

        $('#switch-1').change(function() {
          if ($(this).is(':checked')) {
            circle.set('editable', true);
          } else {
            circle.set('editable', false);
          }
        });

        $('.sidebar-close').click(function() {
          $('#reviews').find('.mdl-list').empty();
          $('#reviews').find('.review-counter').empty();
          $('[href="#reviews"]').parent().addClass('hide');
        });

        $('#switch-2').change(function() {
          if ($(this).is(':checked')) {
            circle.set('draggable', true);
          } else {
            circle.set('draggable', false);
          }
        });
      });
    </script>
  </body>
</html>